# Snort Configuration for ICS Gateway Comparison
# This configuration enables the VULNERABLE Modbus preprocessor (CVE-2022-20685)
#
# For defensive security research only.

#--------------------------------------------------
# Network Variables
#--------------------------------------------------
ipvar HOME_NET 192.168.95.0/24
ipvar EXTERNAL_NET !$HOME_NET

# Modbus server (PLC)
# In NFQUEUE mode, DNAT happens BEFORE packets reach Snort
# So Snort sees destination = 192.168.95.2 (the PLC)
ipvar MODBUS_SERVER 192.168.95.2

# Modbus clients (authorized SCADA/HMI systems)
# Used by Quickdraw rules for access control
# Set to "any" to disable access control checks
ipvar MODBUS_CLIENT any

portvar MODBUS_PORTS 502

#--------------------------------------------------
# Path Variables
#--------------------------------------------------
var RULE_PATH /etc/snort/rules
var SO_RULE_PATH /etc/snort/so_rules
var PREPROC_RULE_PATH /etc/snort/preproc_rules
var WHITE_LIST_PATH /etc/snort/rules
var BLACK_LIST_PATH /etc/snort/rules

#--------------------------------------------------
# Dynamic Libraries (required for Modbus preprocessor)
#--------------------------------------------------
dynamicpreprocessor directory /usr/local/lib/snort_dynamicpreprocessor/
dynamicengine /usr/local/lib/snort_dynamicengine/libsf_engine.so

#--------------------------------------------------
# Decoder Configuration
#--------------------------------------------------
config disable_decode_alerts
config disable_tcpopt_experimental_alerts
config disable_tcpopt_obsolete_alerts
config disable_tcpopt_ttcp_alerts
config disable_tcpopt_alerts
config disable_ipopt_alerts
config checksum_mode: all

#--------------------------------------------------
# Inline Mode (IPS) - NFQUEUE
#--------------------------------------------------
# Policy mode determines how rules with drop/reject actions behave
# inline = actually drop packets (IPS mode)
config policy_mode: inline

# DAQ configuration is set via command line for NFQUEUE:
#   --daq nfq --daq-var queue=0
# This allows iptables NFQUEUE to send packets to Snort

#--------------------------------------------------
# Detection Engine
#--------------------------------------------------
config detection: search-method ac-bnfa search-optimize max-pattern-len 20
config event_queue: max_queue 8 log 5 order_events content_length

#--------------------------------------------------
# Performance Configuration
#--------------------------------------------------
config paf_max: 16000

#--------------------------------------------------
# Preprocessors
#--------------------------------------------------

# Stream5 - Required for Modbus preprocessor
preprocessor stream5_global: \
    track_tcp yes, \
    track_udp yes, \
    track_icmp no, \
    max_tcp 262144, \
    max_udp 131072, \
    max_active_responses 2, \
    min_response_seconds 5

preprocessor stream5_tcp: \
    policy windows, \
    detect_anomalies, \
    require_3whs 180, \
    overlap_limit 10, \
    small_segments 3 bytes 150, \
    timeout 180, \
    ports client 502, \
    ports server 502

preprocessor stream5_udp: timeout 180

# Frag3 - IP defragmentation
preprocessor frag3_global: max_frags 65536
preprocessor frag3_engine: policy windows detect_anomalies overlap_limit 10 min_fragment_length 100 timeout 180

# NOTE: http_inspect removed - not needed for Modbus-only demo
# and requires unicode.map file

#--------------------------------------------------
# SCADA/ICS Preprocessors (VULNERABLE)
#--------------------------------------------------

# Modbus Preprocessor - CONTAINS CVE-2022-20685
# The integer overflow vulnerability is in the Write File Record (0x15) handler
preprocessor modbus: ports { 502 }

# DNP3 Preprocessor (for completeness)
preprocessor dnp3: ports { 20000 } \
    memcap 262144 \
    check_crc

#--------------------------------------------------
# Output Configuration
#--------------------------------------------------
output alert_fast: stdout
output log_tcpdump: snort.pcap

#--------------------------------------------------
# Classification Config (defines classtypes for rules)
#--------------------------------------------------
include /etc/snort/classification.config

#--------------------------------------------------
# Rule Files
#--------------------------------------------------
include $RULE_PATH/local.rules
include $RULE_PATH/modbus.rules

# Digital Bond Quickdraw Rules
# Industry-standard ICS/SCADA detection rules
# Includes MBAP length validation (CVE-2019-14462 detection)
include $RULE_PATH/quickdraw.rules

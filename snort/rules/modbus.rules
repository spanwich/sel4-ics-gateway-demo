# Modbus ICS Security Rules
# These rules detect various Modbus protocol attacks
#
# For defensive security research demonstration.

# ============================================================
# CVE-2019-14462 Detection Attempt
# Heap buffer overflow in libmodbus <= 3.1.2
# Attack: MBAP length field mismatch
# ============================================================

# Alert on any Modbus packet where declared length seems suspicious
# Note: This rule has limitations - it cannot detect all length mismatches
# because Snort sees the TCP payload, not the MBAP header relationship
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Suspicious Large Payload (Possible CVE-2019-14462)"; \
    flow:to_server,established; \
    dsize:>256; \
    classtype:attempted-admin; \
    sid:1000001; \
    rev:1; \
)

# ============================================================
# Modbus Function Code Monitoring
# ============================================================

# Read Coils (0x01)
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Read Coils Request"; \
    flow:to_server,established; \
    modbus_func:1; \
    classtype:protocol-command-decode; \
    sid:1000010; \
    rev:1; \
)

# Read Discrete Inputs (0x02)
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Read Discrete Inputs Request"; \
    flow:to_server,established; \
    modbus_func:2; \
    classtype:protocol-command-decode; \
    sid:1000011; \
    rev:1; \
)

# Read Holding Registers (0x03)
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Read Holding Registers Request"; \
    flow:to_server,established; \
    modbus_func:3; \
    classtype:protocol-command-decode; \
    sid:1000012; \
    rev:1; \
)

# Write Single Coil (0x05) - Potential dangerous operation
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Write Single Coil Request"; \
    flow:to_server,established; \
    modbus_func:5; \
    classtype:protocol-command-decode; \
    priority:2; \
    sid:1000015; \
    rev:1; \
)

# Write Single Register (0x06) - Potential dangerous operation
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Write Single Register Request"; \
    flow:to_server,established; \
    modbus_func:6; \
    classtype:protocol-command-decode; \
    priority:2; \
    sid:1000016; \
    rev:1; \
)

# Write Multiple Coils (0x0F) - Dangerous bulk operation
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Write Multiple Coils Request"; \
    flow:to_server,established; \
    modbus_func:15; \
    classtype:protocol-command-decode; \
    priority:1; \
    sid:1000025; \
    rev:1; \
)

# Write Multiple Registers (0x10) - Dangerous bulk operation
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Write Multiple Registers Request"; \
    flow:to_server,established; \
    modbus_func:16; \
    classtype:protocol-command-decode; \
    priority:1; \
    sid:1000026; \
    rev:1; \
)

# Write File Record (0x15) - Used in CVE-2022-20685 attack
# This function triggers the vulnerable code path in Snort's Modbus preprocessor
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Write File Record Request (CVE-2022-20685 trigger)"; \
    flow:to_server,established; \
    modbus_func:21; \
    classtype:attempted-admin; \
    priority:1; \
    sid:1000031; \
    rev:1; \
)

# ============================================================
# Illegal/Reserved Function Codes
# ============================================================

# Function codes 0x00 is invalid
alert tcp any any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    msg:"MODBUS Illegal Function Code 0x00"; \
    flow:to_server,established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|00|"; offset:7; depth:1; \
    classtype:attempted-admin; \
    sid:1000100; \
    rev:1; \
)

# ============================================================
# Exception Response Monitoring
# ============================================================

# Modbus exception responses (function code | 0x80)
alert tcp $MODBUS_SERVER $MODBUS_PORTS -> any any ( \
    msg:"MODBUS Exception Response"; \
    flow:from_server,established; \
    modbus_func; \
    byte_test:1,&,0x80,0,relative; \
    classtype:protocol-command-decode; \
    sid:1000200; \
    rev:1; \
)

# Digital Bond Quickdraw Modbus TCP Rules
# Source: https://github.com/digitalbond/Quickdraw-Snort
# License: GPL
#
# Version 1.3 03/06/2015
# Tested with Snort 2.9.7.2
#
# Variables required:
#   MODBUS_CLIENT - IP addresses of valid Modbus clients
#   MODBUS_SERVER - IP addresses of valid Modbus servers
#
# Modified for this project:
#   - Changed port from 502 to $MODBUS_PORTS for flexibility
#   - Added comments explaining each rule's purpose

# =============================================================================
# Diagnostic/Admin Function Codes - Potentially Dangerous Operations
# =============================================================================

# Force Listen Only Mode (Function 08, Sub 00 04)
# Impact: Device stops responding to all messages except this one
alert tcp $MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:from_client,established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|08 00 04|"; offset:7; depth:3; \
    msg:"QUICKDRAW: Modbus TCP - Force Listen Only Mode"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:attempted-dos; \
    sid:1111001; rev:3; priority:1; \
)

# Restart Communications (Function 08, Sub 00 01)
# Impact: Resets communication port, clears counters
alert tcp $MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:from_client,established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|08 00 01|"; offset:7; depth:3; \
    msg:"QUICKDRAW: Modbus TCP - Restart Communications Option"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:attempted-dos; \
    sid:1111002; rev:3; priority:1; \
)

# Clear Counters and Diagnostic Registers (Function 08, Sub 00 0A)
# Impact: Clears diagnostic data, hides evidence of attacks
alert tcp $MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:from_client,established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|08 00 0A|"; offset:7; depth:3; \
    msg:"QUICKDRAW: Modbus TCP - Clear Counters and Diagnostic Registers"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:misc-attack; \
    sid:1111003; rev:3; priority:3; \
)

# =============================================================================
# Reconnaissance Function Codes
# =============================================================================

# Read Device Identification (Function 2B)
# Impact: Reveals device type, vendor, firmware version
alert tcp $MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:from_client,established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|2B|"; offset:7; depth:1; \
    msg:"QUICKDRAW: Modbus TCP - Read Device Identification"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:attempted-recon; \
    sid:1111004; rev:3; priority:3; \
)

# Report Server Information (Function 11)
# Impact: Reveals server status and configuration
alert tcp $MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:from_client,established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|11|"; offset:7; depth:1; \
    msg:"QUICKDRAW: Modbus TCP - Report Server Information"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:attempted-recon; \
    sid:1111005; rev:3; priority:3; \
)

# =============================================================================
# Access Control Rules (requires MODBUS_CLIENT whitelist)
# =============================================================================
# NOTE: These rules are DISABLED because MODBUS_CLIENT is set to "any"
# Snort does not allow "!any" in rules.
# To enable: set MODBUS_CLIENT to specific IPs in snort.conf, then uncomment.

# Unauthorized Read Request
# Triggers when client IP is NOT in MODBUS_CLIENT list
# Function codes: 01,02,03,04,07,0B,0C,11,14,17,18,2B (read operations)
# alert tcp !$MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
#     flow:from_client,established; \
#     content:"|00 00|"; offset:2; depth:2; \
#     pcre:"/[\S\s]{3}(\x01|\x02|\x03|\x04|\x07|\x0B|\x0C|\x11|\x14|\x17|\x18|\x2B)/AR"; \
#     msg:"QUICKDRAW: Modbus TCP - Unauthorized Read Request to PLC"; \
#     reference:url,github.com/digitalbond/Quickdraw-Snort; \
#     classtype:bad-unknown; \
#     sid:1111006; rev:2; priority:2; \
# )

# Unauthorized Write Request
# Triggers when client IP is NOT in MODBUS_CLIENT list
# Function codes: 05,06,0F,10,15,16 (write operations)
# alert tcp !$MODBUS_CLIENT any -> $MODBUS_SERVER $MODBUS_PORTS ( \
#     flow:from_client,established; \
#     content:"|00 00|"; offset:2; depth:2; \
#     pcre:"/[\S\s]{3}(\x05|\x06|\x0F|\x10|\x15|\x16)/AR"; \
#     msg:"QUICKDRAW: Modbus TCP - Unauthorized Write Request to PLC"; \
#     reference:url,github.com/digitalbond/Quickdraw-Snort; \
#     classtype:bad-unknown; \
#     sid:1111007; rev:2; priority:1; \
# )

# =============================================================================
# Protocol Violation / DoS Detection
# =============================================================================

# Illegal Packet Size (>300 bytes)
# Standard Modbus TCP max is 260 bytes (MBAP + PDU)
alert tcp $MODBUS_CLIENT any <> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:established; \
    dsize:>300; \
    msg:"QUICKDRAW: Modbus TCP - Illegal Packet Size, Possible DOS Attack"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:non-standard-protocol; \
    sid:1111008; rev:2; priority:1; \
)

# Non-Modbus Communication on Modbus Port
# Modbus TCP protocol ID must be 0x0000 at bytes 2-3
alert tcp $MODBUS_CLIENT any <> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:established; \
    content:!"|00 00|"; offset:2; depth:2; \
    msg:"QUICKDRAW: Modbus TCP - Non-Modbus Communication on Port 502"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:non-standard-protocol; \
    sid:1111009; rev:2; priority:1; \
)

# =============================================================================
# MBAP Length Validation - CVE-2019-14462 Detection
# =============================================================================

# Incorrect Packet Length
# Uses byte_jump to read MBAP length field and verify packet size
# If declared length doesn't match actual data, this triggers
#
# How it works:
#   1. byte_jump:2,4 - Read 2 bytes at offset 4 (MBAP length), jump forward
#   2. isdataat:0,relative - Check if there's data at current position
#   3. If MBAP says 60 bytes but packet has 600, we land at byte 66
#      and find more data -> ALERT
#
# This detects CVE-2019-14462 attacks where attacker declares small
# length but sends large payload to overflow heap buffer.
alert tcp any any <> $MODBUS_SERVER $MODBUS_PORTS ( \
    flow:established; \
    content:"|00 00|"; offset:2; depth:2; \
    byte_jump:2,4; \
    isdataat:0,relative; \
    msg:"QUICKDRAW: Modbus TCP - MBAP Length Mismatch (CVE-2019-14462)"; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    reference:cve,2019-14462; \
    classtype:attempted-admin; \
    sid:1111012; rev:3; priority:1; \
)

# =============================================================================
# Exception Response Monitoring
# =============================================================================

# Slave Device Busy - Multiple occurrences may indicate DoS
alert tcp $MODBUS_SERVER $MODBUS_PORTS -> $MODBUS_CLIENT any ( \
    flow:established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|06|"; offset:8; depth:1; \
    byte_test:1,>=,0x80,7; \
    msg:"QUICKDRAW: Modbus TCP - Slave Device Busy Exception (DoS indicator)"; \
    threshold:type threshold, track by_src, count 3, seconds 60; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:successful-dos; \
    sid:1111010; rev:3; priority:2; \
)

# Acknowledge Exception - Multiple occurrences may indicate DoS
alert tcp $MODBUS_SERVER $MODBUS_PORTS -> $MODBUS_CLIENT any ( \
    flow:established; \
    content:"|00 00|"; offset:2; depth:2; \
    content:"|05|"; offset:8; depth:1; \
    byte_test:1,>=,0x80,7; \
    msg:"QUICKDRAW: Modbus TCP - Acknowledge Exception (DoS indicator)"; \
    threshold:type threshold, track by_src, count 3, seconds 60; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:successful-dos; \
    sid:1111011; rev:3; priority:2; \
)

# =============================================================================
# Scanning Detection
# =============================================================================

# Points List Scan - Attacker enumerating valid data points
alert tcp $MODBUS_SERVER $MODBUS_PORTS -> any any ( \
    flow:established; \
    content:"|00 00|"; offset:2; depth:2; \
    byte_test:1,>=,0x80,7; \
    content:"|02|"; offset:8; depth:1; \
    msg:"QUICKDRAW: Modbus TCP - Points List Scan"; \
    threshold:type threshold, track by_src, count 5, seconds 60; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:attempted-recon; \
    sid:1111013; rev:3; priority:2; \
)

# Function Code Scan - Attacker enumerating supported functions
alert tcp $MODBUS_SERVER $MODBUS_PORTS -> any any ( \
    flow:established; \
    content:"|00 00|"; offset:2; depth:2; \
    byte_test:1,>=,0x80,7; \
    content:"|01|"; offset:8; depth:1; \
    msg:"QUICKDRAW: Modbus TCP - Function Code Scan"; \
    threshold:type threshold, track by_src, count 3, seconds 60; \
    reference:url,github.com/digitalbond/Quickdraw-Snort; \
    classtype:attempted-recon; \
    sid:1111014; rev:3; priority:2; \
)
